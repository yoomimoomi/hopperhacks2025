<<<<<<< HEAD
import itertools
import os

from .compat import py312

from distutils import log
=======
import os
from distutils import log
import itertools

from setuptools.extern.six.moves import map

>>>>>>> 030eb08ce4fc1c2fddcb364aae4f4b677c17bd8b

flatten = itertools.chain.from_iterable


class Installer:
<<<<<<< HEAD
    nspkg_ext = '-nspkg.pth'

    def install_namespaces(self) -> None:
        nsp = self._get_all_ns_packages()
        if not nsp:
            return
        filename = self._get_nspkg_file()
=======

    nspkg_ext = '-nspkg.pth'

    def install_namespaces(self):
        nsp = self._get_all_ns_packages()
        if not nsp:
            return
        filename, ext = os.path.splitext(self._get_target())
        filename += self.nspkg_ext
>>>>>>> 030eb08ce4fc1c2fddcb364aae4f4b677c17bd8b
        self.outputs.append(filename)
        log.info("Installing %s", filename)
        lines = map(self._gen_nspkg_line, nsp)

        if self.dry_run:
            # always generate the lines, even in dry run
            list(lines)
            return

<<<<<<< HEAD
        with open(filename, 'wt', encoding=py312.PTH_ENCODING) as f:
            # Python<3.13 requires encoding="locale" instead of "utf-8"
            # See: python/cpython#77102
            f.writelines(lines)

    def uninstall_namespaces(self) -> None:
        filename = self._get_nspkg_file()
=======
        with open(filename, 'wt') as f:
            f.writelines(lines)

    def uninstall_namespaces(self):
        filename, ext = os.path.splitext(self._get_target())
        filename += self.nspkg_ext
>>>>>>> 030eb08ce4fc1c2fddcb364aae4f4b677c17bd8b
        if not os.path.exists(filename):
            return
        log.info("Removing %s", filename)
        os.remove(filename)

<<<<<<< HEAD
    def _get_nspkg_file(self):
        filename, _ = os.path.splitext(self._get_target())
        return filename + self.nspkg_ext

=======
>>>>>>> 030eb08ce4fc1c2fddcb364aae4f4b677c17bd8b
    def _get_target(self):
        return self.target

    _nspkg_tmpl = (
        "import sys, types, os",
<<<<<<< HEAD
        "p = os.path.join(%(root)s, *%(pth)r)",
        "importlib = __import__('importlib.util')",
        "__import__('importlib.machinery')",
        (
            "m = "
=======
        "has_mfs = sys.version_info > (3, 5)",
        "p = os.path.join(%(root)s, *%(pth)r)",
        "importlib = has_mfs and __import__('importlib.util')",
        "has_mfs and __import__('importlib.machinery')",
        (
            "m = has_mfs and "
>>>>>>> 030eb08ce4fc1c2fddcb364aae4f4b677c17bd8b
            "sys.modules.setdefault(%(pkg)r, "
            "importlib.util.module_from_spec("
            "importlib.machinery.PathFinder.find_spec(%(pkg)r, "
            "[os.path.dirname(p)])))"
        ),
<<<<<<< HEAD
        ("m = m or sys.modules.setdefault(%(pkg)r, types.ModuleType(%(pkg)r))"),
=======
        (
            "m = m or "
            "sys.modules.setdefault(%(pkg)r, types.ModuleType(%(pkg)r))"
        ),
>>>>>>> 030eb08ce4fc1c2fddcb364aae4f4b677c17bd8b
        "mp = (m or []) and m.__dict__.setdefault('__path__',[])",
        "(p not in mp) and mp.append(p)",
    )
    "lines for the namespace installer"

<<<<<<< HEAD
    _nspkg_tmpl_multi = ('m and setattr(sys.modules[%(parent)r], %(child)r, m)',)
=======
    _nspkg_tmpl_multi = (
        'm and setattr(sys.modules[%(parent)r], %(child)r, m)',
    )
>>>>>>> 030eb08ce4fc1c2fddcb364aae4f4b677c17bd8b
    "additional line(s) when a parent package is indicated"

    def _get_root(self):
        return "sys._getframe(1).f_locals['sitedir']"

    def _gen_nspkg_line(self, pkg):
<<<<<<< HEAD
=======
        # ensure pkg is not a unicode string under Python 2.7
        pkg = str(pkg)
>>>>>>> 030eb08ce4fc1c2fddcb364aae4f4b677c17bd8b
        pth = tuple(pkg.split('.'))
        root = self._get_root()
        tmpl_lines = self._nspkg_tmpl
        parent, sep, child = pkg.rpartition('.')
        if parent:
            tmpl_lines += self._nspkg_tmpl_multi
        return ';'.join(tmpl_lines) % locals() + '\n'

    def _get_all_ns_packages(self):
        """Return sorted list of all package namespaces"""
        pkgs = self.distribution.namespace_packages or []
<<<<<<< HEAD
        return sorted(set(flatten(map(self._pkg_names, pkgs))))
=======
        return sorted(flatten(map(self._pkg_names, pkgs)))
>>>>>>> 030eb08ce4fc1c2fddcb364aae4f4b677c17bd8b

    @staticmethod
    def _pkg_names(pkg):
        """
        Given a namespace package, yield the components of that
        package.

        >>> names = Installer._pkg_names('a.b.c')
        >>> set(names) == set(['a', 'a.b', 'a.b.c'])
        True
        """
        parts = pkg.split('.')
        while parts:
            yield '.'.join(parts)
            parts.pop()


class DevelopInstaller(Installer):
    def _get_root(self):
        return repr(str(self.egg_path))

    def _get_target(self):
        return self.egg_link
